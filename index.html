<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Vouchers</title>
    <style>
        /* Estiliza√ß√£o da p√°gina */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
            display: flex;
            justify-content: center; /* Centraliza o conte√∫do na vertical */
            align-items: center; /* Centraliza o conte√∫do na horizontal */
            height: 100vh;
        }

        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Fundo levemente escuro */
            width: 300px;
        }

        h1 {
            color: #333;
        }

        /* Estiliza√ß√£o do bot√£o */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        /* Estiliza√ß√£o das mensagens de sucesso e erro */
        .voucher-info {
            margin-top: 20px;
            font-size: 16px;
			min-height: 25px; /* Define um espa√ßo fixo para evitar altera√ß√µes no tamanho do container */
        }
        
		.success {
			color: green;
			font-weight: bold;
		}

        .error {
            color: red;
            font-weight: bold;
        }
		
		/* Estiliza√ß√£o do √≠cone de copiar */
        .copy-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
			float: right; /* Move o bot√£o para o lado direito */
            display: none; /* Inicialmente escondido */
        }

        .copy-button:hover {
            background-color: #45a049;
        }
		
		/* Estiliza√ß√£o do √≠cone de imprimir */
		.print-button {
			background-color: #4CAF50;
			color: white;
			border: none;
			padding: 8px 12px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			margin-top: 10px;
			float: left; /* Move o bot√£o para o lado esquerdo */
			display: none; /* Inicialmente escondido */
		}

		.print-button:hover {
			background-color: #45a049;
		}
		
		/* Estiliza√ß√£o do Modal para perguntar se tem certeza que quer retirar um novo voucher */
		/*
		.modal {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.3);
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.modal-content {
			background: white;
			padding: 20px;
			border-radius: 10px;
			box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
			text-align: center;
			width: 280px;
		}

		.modal-button {
			background-color: #4CAF50;
			color: white;
			border: none;
			padding: 10px 15px;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			margin: 10px 5px;
		}

		.modal-button:hover {
			background-color: #45a049;
		}
        */
		
        /* Estiliza√ß√£o do rodap√© com link para o GitHub */
		/*
        footer {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #666;
        }

        footer a {
            color: #007bff;
            text-decoration: none;
            font-weight: bold;
        }

        footer a:hover {
            text-decoration: underline;
        }
		*/
    </style>
</head>
<body>
    <div class="container">
        <h1>Controle de Vouchers</h1>
		<!-- Bot√£o para retirar voucher -->
        <button id="getVoucherButton">Retirar voucher</button>
        <!-- √Årea para exibir informa√ß√µes sobre o voucher -->
        <div id="voucherInfo" class="voucher-info"></div>
		<!-- Bot√£o para copiar informa√ß√µes -->
		<button id="copyButton" class="copy-button" onclick="copyVoucherInfo()">üìã</button>
		<!-- Bot√£o para imprimir informa√ß√µes -->
		<button id="printButton" class="print-button" onclick="printVoucherInfo()">üñ®Ô∏è</button>
		<!-- Modal de Confirma√ß√£o -->
		<!-- 
		<div id="customModal" class="modal">
			<div class="modal-content">
				<p>Deseja retirar um novo voucher?</p>
				<button id="confirmYes" class="modal-button">Sim</button>
				<button id="confirmNo" class="modal-button">N√£o</button>
			</div>
		</div>
		-->
    </div>

    <script>
		/* Fun√ß√£o ass√≠ncrona para mostrar um voucher ultimo voucher retirado */
		async function handleVoucherInformation() {
			try {
				const response = await fetch("http://localhost:3000/getVoucherInformation"); // Faz uma requisi√ß√£o GET para obter informa√ß√µes do voucher ativo
                const data = await response.json(); // Converte a resposta para JSON
				
				if (data.message !== "N√£o h√° mais voucher dispon√≠vel!" && data.message !== "N√£o h√° voucher dispon√≠vel!") { // N√£o reiniciar quando n√£o houver mais vouchers
					startCountdown(data.timeLeft); // Inicia ou reinicia a contagem regressiva
				}
                
				updateVoucherInfo(data, response.status); // Atualiza a interface com os dados
				
            } catch (error) {
                console.error("Erro ao mostrar voucher:", error);
				// Exibe a mensagem padr√£o caso ocorra um erro
                document.getElementById("voucherInfo").innerHTML = "<p class='error'>Erro, o servidor pode estar off-line!</p>";
				document.getElementById("copyButton").style.display = "none"; // Esconde o bot√£o de copiar
				document.getElementById("printButton").style.display = "none"; // Exibe o bot√£o de impress√£o
            }
        }
		
	
        /* Fun√ß√£o ass√≠ncrona para retirar um voucher do servidor */
		async function handleVoucherRequest() {
			const button = document.getElementById("getVoucherButton"); // Permite customizar o bot√£o retirar
    		button.disabled = true; // Desativa o bot√£o getVoucherButton para evitar cliques repetidos

			try {
				const response = await fetch("http://localhost:3000/getVoucher"); // Faz uma requisi√ß√£o GET para obter um voucher
                const data = await response.json(); // Converte a resposta para JSON
				
				if (data.message !== "N√£o h√° mais voucher dispon√≠vel!" && data.message !== "N√£o h√° voucher dispon√≠vel!") { // N√£o reiniciar quando n√£o houver mais vouchers
					startCountdown(data.timeLeft); // Inicia ou reinicia a contagem regressiva
				}
				
                updateVoucherInfo(data, response.status); // Atualiza a interface com os dados

				// Remover a mensagem 'data.message' ap√≥s 5 segundos
				clearTimeout(timeoutId); // Cancela qualquer timeout anterior
        		timeoutId = setTimeout(() => {
					const messageElement = document.getElementById("voucherMessage");
					if (messageElement) {
						//messageElement.remove(); // Remove o elemento da DOM
						messageElement.innerHTML = "&nbsp;"; // Substitui a mensagem por um espa√ßo em branco
					}
				}, 5000);
				
            } catch (error) {
                console.error("Erro ao buscar voucher:", error);
				// Exibe a mensagem padr√£o caso ocorra um erro
                document.getElementById("voucherInfo").innerHTML = "<p class='error'>Erro ao tentar retirar voucher!</p>";
                document.getElementById("copyButton").style.display = "none"; // Esconde o bot√£o de copiar
				document.getElementById("printButton").style.display = "none"; // Exibe o bot√£o de impress√£o
            } finally {
				setTimeout(() => { // Reativa o bot√£o getVoucherButton ap√≥s 100 milissegundos
					button.disabled = false;
				}, 100);
			}
        }

        /* Atualiza as informa√ß√µes do voucher na tela */
        function updateVoucherInfo(data, status) {
            const voucherInfoDiv = document.getElementById("voucherInfo");
            const isError = status !== 200; // Verifica se a resposta foi um erro
			// const button = document.getElementById("NOME DO BOT√ÉO"); // Permite customizar o bot√£o retirar
			// button.style.display = "none"; // Esconde o bot√£o
			// button.innerText = "TEXTO DE PREFER√äNCIA"; // Atualiza o texto do bot√£o
			// button.style.display = "block"; // Garante que o bot√£o seja exibido
			
			document.getElementById("getVoucherButton").innerText = "Retirar novo voucher"; // Atualiza o texto do bot√£o
            
            // Exibir apenas a mensagem de indispon√≠vel caso n√£o haja vouchers dispon√≠veis
            if (status !== 200 && data.message === "N√£o h√° voucher dispon√≠vel!") {
                document.getElementById("getVoucherButton").innerText = "Retirar voucher"; // Atualiza o texto do bot√£o
                voucherInfoDiv.innerHTML = `<p class="error">${data.message || "&nbsp;"}</p>`;
                document.getElementById("copyButton").style.display = "none"; // Esconde o bot√£o de copiar
				document.getElementById("printButton").style.display = "none"; // Exibe o bot√£o de impress√£o
                return;
            }

			// Se a resposta for um erro e n√£o houver vouchers dispon√≠veis, apenas atualiza a mensagem
			if (isError && data.message === "N√£o h√° mais voucher dispon√≠vel!") {
				const voucherMessage = document.getElementById("voucherMessage");
				
				if (voucherMessage) {
					voucherMessage.innerText = data.message; // Apenas atualiza a mensagem
					voucherMessage.className = "error"; // Mant√©m a classe de erro
				} else {
					// Se a mensagem n√£o existir na interface, cria ela
					const messageElement = document.createElement("p");
					messageElement.id = "voucherMessage";
					messageElement.className = "error";
					messageElement.innerText = data.message;
					voucherInfoDiv.appendChild(messageElement);
				}
				return; // Sai da fun√ß√£o para n√£o sobrescrever o resto da interface
			}
            
            // Exibir os dados do voucher na interface
            voucherInfoDiv.innerHTML = `
				<p><strong>Voucher: ${data.voucher}</strong></p>
				${data.validity === "00:00:00" ? "" : `<p>Expira: ${data.expiresAt}</p>`} <!-- N√£o mostra essa linha se o tempo do voucher for definido como zero (00:00:00) -->
				${data.validity === "00:00:00" ? "" : `<p>Tempo: <span id="timeLeft">${data.timeLeft}</span></p>`} <!-- N√£o mostra essa linha se o tempo do voucher for definido como zero (00:00:00) -->
                <p>
                Total: ${data.quantity}
                ${data.quantity === 1 ? " voucher" : " vouchers"}
                ${data.quantity > 0 && data.validity !== "00:00:00" 
                    ? ` de ${formatTime(data.validity)}` 
                    : ""}
				<p id="voucherMessage" class="${isError ? 'error' : 'success'}">${data.message || "&nbsp;"}</p>
                </p> <!-- N√£o mostra o tempo dos outros vouchers se o tempo for definido como zero (00:00:00) e se n√£o ouver mais vouchers dispon√≠veis -->
			`;

			// Exibir o bot√£o de copiar somente se houver um voucher
            if (data.voucher && data.expiresAt) {
                document.getElementById("copyButton").style.display = "block"; // Exibe o bot√£o de copiar ("inline-block")
				document.getElementById("printButton").style.display = "block"; // Exibe o bot√£o de impress√£o ("inline-block")
            } else {
                document.getElementById("copyButton").style.display = "none"; // Esconde o bot√£o de copiar
				document.getElementById("printButton").style.display = "none"; // Exibe o bot√£o de impress√£o
            }
		}
		
		/* Fun√ß√£o para copiar as informa√ß√µes do voucher */
        function copyVoucherInfo() {
            const voucherText = voucherInfo.querySelector("p:nth-of-type(1)").innerText; // Voucher
            const expiresAtText = voucherInfo.querySelector("p:nth-of-type(2)").innerText; // Expira
            
            const textToCopy = expiresAtText.startsWith("Expira: ") 
			? `${voucherText}\n${expiresAtText}` // Se segunda linha come√ßa com 'Expira: ', copia ela
			: `${voucherText}`; // Se n√£o, n√£o copia

            // Usando a API Clipboard para copiar o texto
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                    alert('Informa√ß√µes copiadas para a √°rea de transfer√™ncia!');
                })
                .catch(err => {
                    console.error('Erro ao copiar:', err);
                });
			
				location.reload(); // Atualiza a p√°gina para garantir que os eventos e scripts sejam restaurados
        }
		
		/* Fun√ß√£o para imprimir as informa√ß√µes do voucher */
		function printVoucherInfo() {
			const originalContent = document.body.innerHTML; // Clona o conte√∫do do voucher para n√£o afetar a p√°gina original
			
			// Obt√©m as informa√ß√µes espec√≠ficas do voucher
			const voucherText = voucherInfo.querySelector("p:nth-of-type(1)").innerText; // Voucher
    		const expiresAtText = voucherInfo.querySelector("p:nth-of-type(2)").innerText; // Expira
			/*
			const timeLeftText = voucherInfo.querySelector("p:nth-of-type(3)").innerText; // Tempo restante
			const quantityText = voucherInfo.querySelector("p:nth-of-type(4)").innerText; // Quantidade
			const validityText = voucherInfo.querySelector("p:nth-of-type(5)").innerText; // Validade
			*/

			// Substitui o conte√∫do da p√°gina pelo da impress√£o
			document.body.innerHTML = `
				<html>
				<head>
					<title>Voucher</title>
					<style>
						@media print {
							body {
								font-family: Arial, sans-serif; /* Tipo de fonte */
								margin: 0;
								padding: 0;
							}
							p {
								font-size: 18px; /* Tamanho da fonte */
							}
							/* Ocultar cabe√ßalho e rodap√© padr√£o da impress√£o */
							@page {
								margin: 0;
							}
							/* Remover cabe√ßalhos e rodap√©s padr√£o do navegador */
							@page {
								size: auto;
							}
							header, footer {
								display: none;
							}
						}
					</style>
				</head>
				<body>
					<p>
						<strong>${voucherText}</strong>  <!-- Em negrito -->
						<br> <!-- Quebra de linha entre os textos -->
						${expiresAtText.startsWith("Expira: ") ? expiresAtText : ""} <!-- Se segunda linha come√ßa com 'Expira: ', imprime ela -->
					</p>
				</body>
				</html>
			`;

			window.print(); // Aciona a impress√£o

			document.body.innerHTML = originalContent; // Restaura o conte√∫do original ap√≥s a impress√£o
			
			location.reload(); // Atualiza a p√°gina para garantir que os eventos e scripts sejam restaurados
		}
		/*
		function printVoucherInfo() {
			// Obt√©m as informa√ß√µes espec√≠ficas do voucher
			const voucherText = voucherInfo.querySelector("p:nth-of-type(2)").innerText; // Voucher: 
            const expiresAtText = voucherInfo.querySelector("p:nth-of-type(3)").innerText; // Expira: 
			
			// Abre a janela de impress√£o
			const printWindow = window.open('', '', 'height=682,width=769'); // Abre uma nova janela vazia com largura 769 e a altura 682
			
			// Adiciona o conte√∫do da p√°gina
			printWindow.document.write('<html><head><title>Voucher</title></head><body>'); // Define um t√≠tulo da aba
			printWindow.document.write('<p><strong>' + voucherText + '</strong></p>'); // Escreve informa√ß√£o do voucher
			printWindow.document.write('<p>' + expiresAtText + '</p>'); // Escreve informa√ß√£o do voucher
			printWindow.document.write('</body></html>'); // Garante que a estrutura HTML esteja bem formada
			printWindow.document.close(); // Finaliza a escrita no documento
			
			printWindow.print(); // Chama a fun√ß√£o de impress√£o autom√°tica da janela
			printWindow.focus(); // Mant√©m a janela em foco
			
			// Fecha a janela ap√≥s a impress√£o ou se o usu√°rio cancelar
			setTimeout(function () {
				printWindow.close();
			}, 50); // Com um delay de 50ms respeitando o tempo antes da chamada da fun√ß√£o de impress√£o autom√°tica da janela
		}
		*/
		
		let countdownInterval; /* Vari√°vel global para armazenar o intervalo ativo */
		let timeoutId; // Vari√°vel global para armazenar o timeout

        /* Inicia a contagem regressiva do tempo de expira√ß√£o */
		function startCountdown(timeLeft) {
			clearInterval(countdownInterval); // Para qualquer contagem regressiva anterior
			const timeParts = timeLeft.match(/(\d+)h (\d+)m (\d+)s/); // Extrai horas, minutos e segundos do tempo restante
			if (!timeParts) return; // Se timeParts for null (caso a string n√£o esteja no formato esperado), a fun√ß√£o sai imediatamente (return) para evitar erros

			let totalSeconds = parseInt(timeParts[1]) * 3600 + parseInt(timeParts[2]) * 60 + parseInt(timeParts[3]); // Converte para segundos

			countdownInterval = setInterval(() => {
				//Se totalSeconds chegar a 0, a contagem para
				if (totalSeconds <= 0) {
					clearInterval(countdownInterval); // Cancela a execu√ß√£o do setInterval()
					document.getElementById("timeLeft").innerText = "Expirado"; // Atualiza a interface (innerText) para exibir "Expirado"
					return;
				}

				totalSeconds--; // Decrementa o tempo restante a cada segundo
				let hours = Math.floor(totalSeconds / 3600); // Hora restante
				let minutes = Math.floor((totalSeconds % 3600) / 60); // Minutos restantes
				let seconds = totalSeconds % 60; // Segundos restantes

				document.getElementById("timeLeft").innerText = `${hours}h ${minutes}m ${seconds}s`; // Atualiza o tempo restante na interface
			}, 1000); // Usa setInterval() para executar um bloco de c√≥digo a cada 1000ms (1 segundo)
		}
        
        /* Formata o tempo para exibi√ß√£o no formato "xh ym zs" */
        function formatTime(time) {
            const parts = time.split(':'); // Divide a string no formato HH:MM:SS
            const hours = parseInt(parts[0], 10);
            const minutes = parseInt(parts[1], 10);
            const seconds = parseInt(parts[2], 10);
            return `${hours}h ${minutes}m ${seconds}s`;
        }
		
		/* Adiciona um evento autom√°tico quando a p√°gina for carregada para exibir voucher ativo */
		document.addEventListener("DOMContentLoaded", async () => {
			await handleVoucherInformation();
		});

		/* Adiciona um evento de clique ao bot√£o para retirar um novo voucher */
		//document.getElementById("getVoucherButton").addEventListener("click", handleVoucherRequest);
		
        /* Adiciona um evento de clique ao bot√£o para retirar um novo voucher */
		document.getElementById("getVoucherButton").addEventListener("click", async function () {
			const button = this; // Refer√™ncia ao bot√£o
			
			try {
				const response = await fetch("http://localhost:3000/askGetVoucher");
				const data = await response.json();

				if (data.requireConfirmation) {
					const confirmar = confirm("Voc√™ est√° retirando um novo voucher!");
					if (!confirmar) {
						location.reload(); // Atualiza a p√°gina para garantir que os eventos e scripts sejam restaurados
						return; // Cancela a retirada se o usu√°rio n√£o confirmar
					}
				}

				handleVoucherRequest(); // Chama a fun√ß√£o para processar o voucher

			} catch (error) {
				console.error("Erro ao buscar informa√ß√µes do voucher:", error);
			}
			
			/*
			if (button.textContent.startsWith("Retirar novo")) {
				// Exibe o modal de confirma√ß√£o
				document.getElementById("customModal").style.display = "flex";

				// Evento para o bot√£o "Sim"
				document.getElementById("confirmYes").onclick = function () {
					document.getElementById("customModal").style.display = "none";
					handleVoucherRequest(); // Chama a fun√ß√£o se confirmado
				};

				// Evento para o bot√£o "N√£o"
				document.getElementById("confirmNo").onclick = function () {
					document.getElementById("customModal").style.display = "none";
				};

				return; // Interrompe a execu√ß√£o para aguardar a resposta do usu√°rio
			}
			handleVoucherRequest(); // Chama a fun√ß√£o para obter o voucher
			*/
		});
		
		/* Adiciona um evento chamando a fun√ß√£o copyVoucherInfo para copiar os dados do voucher ativo se pressionar 'Ctrl + c'  */
		document.addEventListener("keydown", function(event) {
			if (event.ctrlKey && event.key === "c") { // Verifica se Ctrl + c foi pressionado
				const selectedText = window.getSelection().toString(); // Pega o texto selecionado
				
				if (!selectedText) { // Se n√£o houver texto selecionado
					event.preventDefault(); // Impede o comportamento padr√£o do Ctrl+C
					copyVoucherInfo(); // Chama a fun√ß√£o de c√≥pia personalizada
				}
			}
		});
		
		/* Adiciona um evento chamando a fun√ß√£o printVoucherInfo para imprimir os dados do voucher ativo se pressionar 'Ctrl + p'  */
		document.addEventListener("keydown", function(event) {
			if (event.ctrlKey && event.key === "p") { // Verifica se Ctrl + p foi pressionado
				event.preventDefault(); // Impede o comportamento padr√£o do Ctrl + p
				printVoucherInfo(); // Chama a fun√ß√£o de c√≥pia personalizada
			}
		});
		
		/* Mantem a p√°gina web atualizada com novas informa√ß√µes, mesmo que o servidor tenha sido reiniciado */
		setInterval(async () => {
			try {
				// Realiza uma requisi√ß√£o ass√≠ncrona para o endpoint "/healthCheck" no servidor local (localhost).
				const response = await fetch("http://localhost:3000/healthCheck");
				
				// Se o servidor est√° funcionando
				if (response.ok) {
					// Extrai o tempo de in√≠cio do servidor (retornado pelo endpoint) como texto
					const serverStartTime = await response.text();
					
					// Recupera o valor armazenado no sessionStorage, que cont√©m o tempo do √∫ltimo in√≠cio do servidor (se j√° tiver sido armazenado em uma visita anterior)
					const lastLoadTime = sessionStorage.getItem("serverStartTime");
					
					// Se o tempo atual de in√≠cio do servidor for diferente do tempo armazenado, significa que o servidor foi reiniciado
					if (lastLoadTime !== serverStartTime) {
						// Atualiza o sessionStorage com o novo tempo de in√≠cio do servidor
						sessionStorage.setItem("serverStartTime", serverStartTime);
						
						location.reload(); // Recarrega a p√°gina atual se o servidor foi reiniciado
					}
				}
			} catch (error) {
				console.warn("Erro ao verificar servidor:", error);
			}
		}, 5000); // A fun√ß√£o setInterval √© chamada para ser executada a cada 5 segundos (5000ms).
	</script>
    <!-- 
    <footer>
        <p><a href="https://github.com/o0andrefelipe0o/controle-de-vouchers" target="_blank">@o0andrefelipe0o</a></p>
    </footer>
	 -->
</body>
</html>
